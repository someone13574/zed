#!/usr/bin/env node --redirect-warnings=/dev/null

const { execFileSync } = require("child_process");

main();

async function main() {
  let version = process.argv[2];
  let channel = process.argv[3];
  let parts = version.split(".");

  if (
    process.argv.length != 4 ||
    parts.length != 3 ||
    parts.find((part) => isNaN(part)) != null ||
    (channel != "stable" && channel != "preview" && channel != "flatpak")
  ) {
    console.log("Usage: draft-release-notes <version> {stable|preview|flatpak}");
    process.exit(1);
  }

  let priorVersion = [parts[0], parts[1], parts[2] - 1].join(".");
  let suffix = "";

  if (channel == "preview" || channel == "flatpak") {
    suffix = "-pre";
    if (parts[2] == 0) {
      priorVersion = [parts[0], parts[1] - 1, 0].join(".");
    }
  } else if (!ensureTag(`v${priorVersion}`)) {
    console.log("Copy the release notes from preview.");
    process.exit(0);
  }

  let [tag, priorTag] = [`v${version}${suffix}`, `v${priorVersion}${suffix}`];

  if (!ensureTag(tag) || !ensureTag(priorTag)) {
    console.log("Could not draft release notes, missing a tag:", tag, priorTag);
    process.exit(0);
  }

  const newCommits = getCommits(priorTag, tag);

  let releaseNotes = [];
  let missing = [];
  let skipped = [];

  for (const commit of newCommits) {
    let link = "https://github.com/zed-industries/zed/pull/" + commit.pr;
    let notes = commit.releaseNotes;
    if (commit.pr == "") {
      link = "https://github.com/zed-industries/zed/commits/" + commit.hash;
    } else if (channel == "flatpak") {
      const lines = notes.split("\n");
      for (var i = 0; i < lines.length; i++) {
        line = lines[i];
        line = line.replaceAll("<", "&lt;");
        line = line.replaceAll(">", "&gt;");
        line = line.replace(/^\s*(-|\*)/, ""); // remove bullet point
        line = line.replaceAll(/\(\[(#|\d|\s)+\]\((\w|:|\/|\.|-)*\)\)/g, ""); // remove links to issues
        line = line.replaceAll(/\(#(\d|\s)*\)/g, ""); // remove issue numbers in brackets
        line = line.replace(/\s+\./, ""); // remove spaces before periods
        line = "<li>" + line.trim() + "</li>"
        line = line.replace(/([^.])<\/li>$/, '$1.</li>'); // add missing periods

        if (/#\d*/.test(line)) { // if the notes contain an issue number without brackets or a link, it likely is the low-effort type flathub wants to avoid
          continue;
        } else if (line.length > 200) {
          continue;
        } else if (line == "<li>N/A.</li>" || line == "<li>.</li>") {
          continue;
        }

        releaseNotes.push(" ".repeat(20) + line);
      }

      continue;
    } else if (!notes.includes("zed-industries/zed/issues")) {
      notes = notes + " ([#" + commit.pr + "](" + link + "))";
    }

    if (commit.releaseNotes == "") {
      missing.push("- MISSING " + commit.firstLine + " " + link);
    } else if (commit.releaseNotes.startsWith("- N/A")) {
      skipped.push("- N/A " + commit.firstLine + " " + link);
    } else {
      releaseNotes.push(notes);
    }
  }

  if (channel == "preview") {
    console.log(releaseNotes.join("\n") + "\n");
    console.log("<!-- ");
    console.log(missing.join("\n"));
    console.log(skipped.join("\n"));
    console.log("-->");
  } else if (channel == "flatpak") {
    var date = new Date();

    console.log("Add the following to the top of the <releases> section of dev.zed.Zed.metainfo.xml.");
    console.log("NOTE: Choose the top 5 most important bullet points.\n\n");
    console.log("-".repeat(process.stdout.columns));

    console.log("        <release version=\"%s\" date=\"%s\">", version, date.toISOString());
    if (releaseNotes.length != 0) {
      console.log("            <description>");
      console.log("                <ul>");
      console.log(releaseNotes.join("\n"));
      console.log("                </ul>");
      console.log("            </description>");
    }
    console.log("            <url>https://github.com/zed-industries/zed/releases/tag/%s</url>", tag);
    console.log("        </release>");
    console.log("-".repeat(process.stdout.columns));
    console.log("\n\nAdd the above to the top of the <releases> section of dev.zed.Zed.metainfo.xml.")
    console.log("NOTE: Choose the top 5 most important bullet points.");
  }
}

function getCommits(oldTag, newTag) {
  const pullRequestNumbers = execFileSync(
    "git",
    ["log", `${oldTag}..${newTag}`, "--format=DIVIDER\n%H|||%B"],
    { encoding: "utf8" },
  )
    .replace(/\r\n/g, "\n")
    .split("DIVIDER\n")
    .filter((commit) => commit.length > 0)
    .map((commit) => {
      let [hash, firstLine] = commit.split("\n")[0].split("|||");
      let cherryPick = firstLine.match(/\(cherry-pick #([0-9]+)\)/)?.[1] || "";
      let pr = firstLine.match(/\(#(\d+)\)$/)?.[1] || "";
      let releaseNotes = (commit.split(/Release notes:.*\n/i)[1] || "")
        .split("\n\n")[0]
        .trim()
        .replace(/\n(?![\n-])/g, " ");

      if (releaseNotes.includes("<public_issue_number_if_exists>")) {
        releaseNotes = "";
      }

      return {
        hash,
        pr,
        cherryPick,
        releaseNotes,
        firstLine,
      };
    });

  return pullRequestNumbers;
}

function ensureTag(tag) {
  try {
    execFileSync("git", ["rev-parse", "--verify", tag]);
    return true;
  } catch (e) {
    try {
      execFileSync("git"[("fetch", "origin", "--shallow-exclude", tag)]);
      execFileSync("git"[("fetch", "origin", "--deepen", "1")]);
      return true;
    } catch (e) {
      return false;
    }
  }
}

#!/bin/bash
cd "$(dirname "$0")"

if [[ $1 ]]; then
    channel=$1
else
    echo "Please supply the target channel."
    echo "Possible values: ['dev', 'nightly', 'preview', 'stable']"
    exit
fi

if [[ $2 ]]; then
    method=$2
else
    echo "Please supply packaging method. See 'docs/src/development/linux.md' for details."
    echo "Possible values: ['build', 'copy']."
    exit
fi

if [[ "$channel" == "dev" ]]; then
    app_id="dev.zed.Zed-Dev"
elif [[ "$channel" == "nightly" ]]; then
    app_id="dev.zed.Zed-Nightly"
elif [[ "$channel" == "preview" ]]; then
    app_id="dev.zed.Zed-Preview"
elif [[ "$channel" == "stable" ]]; then
    app_id="dev.zed.Zed"
else
    echo "Invalid channel '$channel'"
    echo "Possible values: ['dev', 'nightly', 'preview', 'stable']"
    exit
fi

manifest_path="../../${app_id}.json"
cp "../../crates/zed/resources/flatpak/manifest-template.json" "${manifest_path}"

if [[ "$method" == "build" ]]; then
    copy_build="false"
elif [[ "$method" == "copy" ]]; then
    copy_build="true"
    sed -i "s|,\n                \"crates/zed/resources/flatpak/flatpak-cargo-sources.json\"||g" "${manifest_path}"
else
    echo "Invalid packaging method '$method'. See 'docs/src/development/linux.md' for details."
    echo "Possible values: ['build', 'copy']."
    exit
fi

sed -i "s|@app_id@|$app_id|g" "${manifest_path}"
sed -i "s|@channel@|$channel|g" "${manifest_path}"
sed -i "s|@copy_build@|$copy_build|g" "${manifest_path}"